# ---------------------------------------
# Step 0: Preview configuration
# ---------------------------------------
- name: Preview backup configuration
  debug:
    msg:
      - "Backup destination: {{ backup_destination }}"
      - "{% if backup_destination == 'remote' %}Remote host: {{ remote_host }}, Path: {{ remote_path }}{% elif backup_destination == 'azure' %}Azure Blob: account={{ azure_storage_account }}, container={{ azure_container }}{% else %}Local backup at {{ backup_base_dir }}{% endif %}"
      - "Backup schedule: {{ backup_frequency }} at {{ backup_time }}"
      - "Retention policy: {{ retain_days }} days"
      - "Databases available: {{ backup_db | map(attribute='name') | list }}"
      - "Project folders: {{ backup_files }}"

- name: Ask for confirmation before backup
  vars_prompt:
    - name: "confirm_backup"
      prompt: "Do you want to proceed with the backup? (yes/no)"
      private: no

- name: Abort if user does not confirm
  meta: end_play
  when: confirm_backup != "yes"

# ---------------------------------------
# Step 1: List DB and select one
# ---------------------------------------
- import_tasks: list_db.yml

# ---------------------------------------
# Step 2: Backup DB and show short log
# ---------------------------------------
- import_tasks: backup_db.yml

# ---------------------------------------
# Step 2b: Notify on database backup failure
# ---------------------------------------
- name: Notify on database backup failure
  mail:
    host: "{{ smtp_host }}"
    port: "{{ smtp_port }}"
    to: "{{ notification_email }}"
    subject: "Backup Failed: Database {{ selected_db }}"
    body: |
      The backup of database '{{ selected_db }}' has failed on {{ ansible_date_time.date }}.
      Please check the backup logs at {{ backup_base_dir }}/db/ for details.
  when: db_backup_result is failed

# ---------------------------------------
# Step 3: Always backup Nginx and site files
# ---------------------------------------
- name: Ensure backup files folder exists
  file:
    path: "{{ backup_base_dir }}/files"
    state: directory
    mode: '0755'

- name: Backup project folders
  archive:
    path: "{{ backup_files }}"
    dest: "{{ backup_base_dir }}/files/site_{{ ansible_date_time.iso8601_basic }}.tar.gz"
    format: gz
  register: folder_backup_result
  ignore_errors: yes

- name: Backup Nginx config
  archive:
    path: /etc/nginx
    dest: "{{ backup_base_dir }}/files/nginx_{{ ansible_date_time.iso8601_basic }}.tar.gz"
    format: gz
  register: nginx_backup_result
  ignore_errors: yes

# ---------------------------------------
# Step 4: Upload based on destination
# ---------------------------------------
- name: Upload backup based on configuration
  block:
    - name: Upload to remote host
      when: backup_destination == 'remote'
      synchronize:
        src: "{{ backup_base_dir }}/"
        dest: "{{ remote_path }}"
        mode: push
        dest_host: "{{ remote_host }}"

    - name: Upload to Azure Blob
      when: backup_destination == 'azure'
      azure.azcollection.azure_rm_storageblob:
        container_name: "{{ azure_container }}"
        blob: "{{ item | basename }}_{{ ansible_date_time.iso8601_basic }}.tar.gz"
        src: "{{ item }}"
        account_name: "{{ azure_storage_account }}"
        sas_token: "{{ azure_sas_token }}"
      loop: "{{ backup_files + [ selected_db | default('') ] }}"

# ---------------------------------------
# Step 5: Show latest DB logs
# ---------------------------------------
- name: Show latest database backup logs
  shell: "ls -lt {{ backup_base_dir }}/db/ | head -n 5"
  register: latest_db_logs

- name: Display latest database logs
  debug:
    msg: "{{ latest_db_logs.stdout_lines }}"

# ---------------------------------------
# Step 6: Cleanup old backups
# ---------------------------------------
- name: Cleanup old backups
  find:
    paths: "{{ backup_base_dir }}"
    age: "{{ retain_days }}d"
    recurse: yes
  register: old_backups

- name: Remove old backups
  file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ old_backups.files }}"
  when: old_backups.matched > 0

# ---------------------------------------
# Step 7: Configure scheduled backup
# ---------------------------------------
- name: Configure cron job for automated backup
  cron:
    name: "Automated Backup Job"
    minute: "0"
    hour: "{{ backup_time.split(':')[0] }}"
    job: "/usr/bin/ansible-playbook /opt/backup-ansible/playbook.yml >> /var/log/backup.log 2>&1"
    state: present

# ---------------------------------------
# Step 8: Exit with summary
# ---------------------------------------
- name: Final summary and exit
  debug:
    msg:
      - "âœ… Backup process completed successfully."
      - "Destination: {{ backup_destination }} {% if backup_destination == 'remote' %}on {{ remote_host }}{% elif backup_destination == 'azure' %}on Azure Blob container {{ azure_container }}{% else %}locally{% endif %}"
      - "Database backed up: {{ selected_db }}"
      - "Project folders backed up: {{ backup_files }}"
      - "Backup files are readable at: {{ backup_base_dir }}"
- meta: end_play
