---
- name: Database and Project Backup with Azure Blob Storage using SAS Token
  hosts: localhost
  connection: local
  vars_files:
    - vars.yml
  vars:
    timestamp: "{{ ansible_date_time.epoch }}"
    
  tasks:
    - name: Ensure backup directory exists
      file:
        path: "{{ backup_base_path }}"
        state: directory
        mode: '0755'
      become: yes

    - name: Load backup configuration from JSON template
      set_fact:
        backup_config: "{{ lookup('template', 'templates/backup_config.json') | from_json }}"

    - name: Validate backup configuration
      fail:
        msg: "Backup configuration must contain either 'databases' or 'projects'"
      when: 
        - backup_config.databases is not defined
        - backup_config.projects is not defined

    - name: Install required packages
      package:
        name:
          - python3
          - python3-pip
        state: present
      become: yes

    - name: Install Azure Blob Storage SDK
      pip:
        name: azure-storage-blob
        executable: pip3

    - name: Create backup script from template
      template:
        src: templates/backup-script.j2
        dest: "{{ backup_base_path }}/backup-script.py"
        mode: '0755'

    - name: Copy Azure upload helper script
      copy:
        src: files/azure_upload.py
        dest: "{{ backup_base_path }}/azure_upload.py"
        mode: '0755'

    - name: Execute backup
      command: "python3 {{ backup_base_path }}/backup-script.py"
      environment:
        AZURE_STORAGE_ACCOUNT_NAME: "{{ azure_account_name }}"
        AZURE_STORAGE_SAS_TOKEN: "{{ azure_sas_token }}"
        AZURE_STORAGE_CONTAINER_NAME: "{{ azure_container_name }}"
      register: backup_result
      changed_when: false

    - name: Display backup results
      debug:
        var: backup_result.stdout_lines